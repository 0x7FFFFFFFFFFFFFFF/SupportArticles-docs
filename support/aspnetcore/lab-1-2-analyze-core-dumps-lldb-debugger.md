---
title: Open and analyze system generated core dump
description: This article describes how to install and configure the lldb debugger in Linux, then open and analyze system generated .NET Core dump in lldb debugger.
ms.date: 04/07/2021
ms.prod: aspnet-core
ms.reviewer: ramakoni
---
# Lab 1.2 Troubleshooting a crash problem - Opening and analyzing system generated core dump in lldb debugger

_Applies to:_ &nbsp; .NET Core 2.1, .NET Core 3.1  

This article introduces how to install and configure the lldb debugger in Linux, then open and analyze system generated .NET Core dump in lldb debugger.

## Prerequisites

The minimum requirement to follow these troubleshooting labs is to have an ASP.NET Core application that demonstrates low and high CPU performance problems and crash issues.

You may find several sample applications that achieve these goals on the Internet. For example, you may download, set up and use [Microsoft's simple webapi sample](/samples/dotnet/samples/diagnostic-scenarios/) which demonstrates undesirable behaviors. Or, you can use BuggyAmb ASP.NET Core application for the sample project.

If you have followed the previous parts of these series up to this point, you should have the following setup ready to continue:

- Nginx configured to host two websites:
  - The first web site listening for requests with the **myfirstwebsite** host header (`http://myfirstwebsite`) and routing the requests to the demo ASP.NET Core application, which is listening on port 5000.
  - The second web site listening for requests with host header **buggyamb** (`http://buggyamb`) and routing the requests to the second ASP.NET Core sample buggy application, which is listening on port 5001.
- Both ASP.NET Core applications should be running as services, which restart automatically when the server is rebooted, or the applications stops or crashes.
- Linux local firewall is enabled and configured to allow SSH and HTTP traffic.

> [!NOTE]
> If your set up is not ready, there is a quick Linux installation guide to run BuggyAmb behind Nginx here.

In order to continue with the lab, you will need to have at least one problematic ASP.NET Core web application running behind Nginx.

## Goal of this lab

This is the second part of the debugging crashes for ASP.NET Core applications on Linux lab.

In the [previous part](lab-1-1-reproduce-troubleshoot), you followed the steps to reproduce a crash problem and started troubleshooting. You checked Nginx and system logs and decided to proceed with troubleshooting by gathering and then analyzing a memory dump. You extracted the crash core dump generated by Apport, Ubuntu's core dump manager.

In this part, you will first install and configure the lldb debugger to work with the .NET Core debugger extension called SOS and then proceed to open the dump in lldb and analyze it.

## Installing lldb

You will need to install lldb 3.9 or newer. Instructions for several Linux distros are detailed in [this article](https://github.com/dotnet/diagnostics/blob/main/documentation/lldb/linux-instructions.md). For this section, we recommend you use apt install command to install it: `sudo apt install lldb`. As you can see the lldb-6.0 is installed along with some dependencies:

:::image type="content" source="./media/lab-1-2-analyze-core-dumps-lldb-debugger/sudo.png" alt-text="BuggyAmb sudo" border="true":::

After the installation has completed, you have to configure lldb so it can automatically load **SOS** when a core dump is opened.

## Configuring lldb

To open the core dump file in lldb, you need to go through the following steps first. These are required for setting the symbol path, downloading the symbols, and loading the **SOS** automatically when lldb is opened. This is well explained in this article. The steps are outlined below:

- Install the dotnet-symbol tool: `dotnet tool install -g dotnet-symbol`
- Download the symbols for the target dump file: `dotnet-symbol <path_of_dump_file>`
- Installing SOS:
  1. First you need to install the dotnet-sos global tool: `dotnet tool install -g dotnet-sos`
  1. Then you can proceed to install SOS: `dotnet-sos install`

## Installing dotnet-symbol tool

You should have already installed the dotnet-symbol tool along with dotnet-dump and dotnet-gcdump tool in previous section. If you have not installed them yet, refer to the previous section and install the before you proceed. You simply need to run the `dotnet tool install -g dotnet-symbol` command to install dotnet-symbols. Install dotnet-dump and dotnet-gcdump as well if you haven't installed these already. After the installation you should have three tools installed as shown below:

:::image type="content" source="./media/lab-1-2-analyze-core-dumps-lldb-debugger/list.png" alt-text="BuggyAmb list" border="true":::

## Downloading the symbols for the dump file

In the [previous part](lab-1-1-reproduce-troubleshoot.md) you were instructed how to unpack the core dump file from apport report. Now it is time to download the symbol files. Put, symbol files are mappings between the source code and the binaries helping the person doing the debugging to view the correct method names and local variables when displaying stacks. Symbol files help you achieve much more than this but it is out of scope for this training.

You will use the `dotnet-symbol ~/dumps/dotnet/CoreDump -o ~/dumps/symbols --host-only` command to download the symbols for the memory dump file to *:::no-loc text="~/dumps/symbols":::* directory:

:::image type="content" source="./media/lab-1-2-analyze-core-dumps-lldb-debugger/dumps.png" alt-text="BuggyAmb dumps" border="true":::

You may get several HTTP 404 not found errors when downloading symbols if you don't add the --host-only switch. You can ignore these errors should you see them. The `--host-only` parameter will download just the "host program", which is all lldb needs to get started debugging the ASP.NET Core application.

The next step will be to install the managed debugging extension SOS, which will expose the .NET debugging commands needed to perform the analysis.

## Installing SOS

What is SOS? According to the [official documentation](https://github.com/dotnet/diagnostics/blob/main/documentation/sos.md), SOS is a debugger extension that allows a developer to inspect the managed state of a .NET Core and desktop runtime process. SOS can be loaded by WinDbg/cdb debuggers on Windows and lldb on Linux and MacOS.

To install SOS you need to first install dotnet-sos tool: `dotnet tool install -g dotnet-sos`

Then install SOS: `dotnet-sos install`

Below is the screenshot showing the result of a successful installation. Notice that the dotnet-sos tool has configured lldb debugger so the SOS extension should be loaded automatically when the debugger starts:

:::image type="content" source="./media/lab-1-2-analyze-core-dumps-lldb-debugger/install.png" alt-text="BuggyAmb install" border="true":::

You are finally ready to open the dump file using lldb.

## Opening core dump in lldb

You need to open the core dump with lldb using the following syntax:

```cmd
lldb --core <dump path> <host-program>
```

The `<host-program>` is the native program that started the .NET Core application. That is usually dotnet unless the application is self-contained. If it is a self-contained application, then it is the name of the application without the *.dll*.

The path to the memory dump file you generated in the previous section should be (assuming you followed along with the same folder names): `~/dumps/dotnet/CoreDump` so you will run `lldb --core ~/dumps/dotnet/CoreDump` command to open the file:

:::image type="content" source="./media/lab-1-2-analyze-core-dumps-lldb-debugger/lldb.png" alt-text="BuggyAmb lldb" border="true":::

The above screenshot shows the lldb debugger that has opened the memory dump file.

## Setting symbols

Remember you have downloaded the symbols with the `dotnet-symbol` command in the *:::no-loc text="~/dumps/symbols":::* directory. The first command you should execute inside the debugger is to set the symbol server path to the directory you configured for the symbol downloads:

```cmd
setsymbolserver -directory ~/dumps/symbols
```

Then proceed to load the symbols:

`loadsymbols`

:::image type="content" source="./media/lab-1-2-analyze-core-dumps-lldb-debugger/loadsymbols.png" alt-text="BuggyAmb loadsymbols" border="true":::

## Running lldb and SOS commands

There are several lldb commands, which can be listed with `help` command. If you run `help` and take a quick look at the available commands (which I recommend you do), you will see that the SOS commands are also listed under **user defined commands**. SOS is a plugin for lldb and plugin help information can be retrieved with the same `help` command.

> [!NOTE]
> You may want to clear the lldb output sometimes. Simply select Ctrl+L to clear the lldb output.

To begin, look at the thread's native callstack with the `bt` command. bt means "back trace" and it shows the call stack of the active thread:

:::image type="content" source="./media/lab-1-2-analyze-core-dumps-lldb-debugger/bt.png" alt-text="BuggyAmb bt" border="true":::

Now look at the managed call stack with SOS `clrstack` command:

:::image type="content" source="./media/lab-1-2-analyze-core-dumps-lldb-debugger/clrstack.png" alt-text="BuggyAmb clrstack" border="true":::

You should not be able tp retrieve any information, the stack walk will have failed because the reported stack is incomplete. This is related to what was discussed before: the auto-generated core dump file is not able to collect all managed state.

Continuing to look around to get some more information, you can recall that an exception had occurred, and this caused the process to crash. Take a look at the exception information with SOS' `pe` command:

:::image type="content" source="./media/lab-1-2-analyze-core-dumps-lldb-debugger/pe.png" alt-text="BuggyAmb pe" border="true":::

Remember the **resource unavailable** message generated by the command. In the meantime, you can already see type of exception and the function names are not resolved and shown as **unknown**. The address of the exception is also displayed, and you can give this address as a parameter to pe command to get more details. Run the `pe 00007F8244048538` command (replacing the address with that displayed in your dump file), however this will not aid to advance the investigation too much since the function names are still listed as unknown:

:::image type="content" source="./media/lab-1-2-analyze-core-dumps-lldb-debugger/unknow.png" alt-text="BuggyAmb unknow" border="true":::

Even if you wish to display the objects referenced in the stack, you get the same unknown messages:

:::image type="content" source="./media/lab-1-2-analyze-core-dumps-lldb-debugger/dso.png" alt-text="BuggyAmb dso" border="true":::

You can try and retrieve some more information by picking an address of one of the objects on the stack and reviewing the object using the `dumpobj <address>` command:

:::image type="content" source="./media/lab-1-2-analyze-core-dumps-lldb-debugger/dumpobj.png" alt-text="BuggyAmb dumpobj" border="true":::

However, you will come to the conclusion that this too will only yield more unknown messages. It is time to stop working with the auto-generated dump file. Run `exit` command to exit the lldb session.

To conclude, the dump file generated by system gave us some information, but we are still missing some important information. In the next section, you will be presented with the "recommended approach" to capture crash dump.

## Next steps

[Lab 1.3 Capture core crash dumps](lab-1-3-capture-core-crash-dumps)
